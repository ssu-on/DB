import:
  - 'experiments/seg_detector/base_td500.yaml'
package: []
define:
  - name: train_data
    class: ImageDataset
    data_dir:
      - './datasets/Subtitles'  # Subtitle dataset only for Stage 2
    data_list:
      - './datasets/Subtitles/train_list.txt'
    processes:
      - class: AugmentDetectionData
        augmenter_args:
          - ['Fliplr', 0.3]
          - {'cls': 'Affine', 'rotate': [-3, 3]}
          - ['Resize', [0.7, 1.4]]
        only_resize: False
        keep_ratio: False
      - class: RandomCropData
        size: [736, 736]
        max_tries: 10
      - class: MakeICDARData
      - class: MakeSegDetectionData
      - class: MakeBorderMap
      - class: NormalizeImage
      - class: FilterKeys
        superfluous: ['filename', 'shape', 'is_training']

  - name: validate_data
    class: ImageDataset
    data_dir:
      - './datasets/Subtitles/'
    data_list:
      - './datasets/Subtitles/test_list.txt'
    processes:
      - class: AugmentDetectionData
        augmenter_args:
          - ['Resize', {'width': 736, 'height': 736}]
        only_resize: True
        keep_ratio: True
      - class: MakeICDARData
      - class: MakeSegDetectionData
      - class: NormalizeImage

  - name: 'Experiment'
    class: Experiment
    structure: 
        class: Structure
        builder: 
            class: Builder
            model: SegDetectorModel
            model_args:
                backbone: deformable_resnet18
                decoder: SegDetector
                decoder_args: 
                    adaptive: True
                    in_channels: [64, 128, 256, 512]
                    k: 50
                    enable_subtitle_branch: True
                    subtitle_inner_channels: 256
                # Freeze 설정: Stage 2 학습 시 backbone/fuse freeze, subtitle branch만 학습
                freeze_for_subtitle_branch: True
                loss_class: SubtitleBranchLoss
                loss_kwargs:
                    bce_weight: 1.0
                    dice_weight: 1.0
                    lambda_intra: 1.0
                    lambda_inter: 1.0
                    margin: 0.5
                    text_binary_threshold: 0.3
                    eps: 1e-6
        representer:
            class: SegDetectorRepresenter
            # subtitle 전용 평가를 위해 subtitle_binary 맵을 사용
            # GT가 subtitle만 라벨링되어 있으면, scene text 검출은 전부 FP로 들어가게 됨
            dest: subtitle_binary
            max_candidates: 1000
            thresh: 0.25        # @@
            box_thresh: 0.6     # @@
        measurer:  
            class: QuadMeasurer
        visualizer:  
            class: SegDetectorVisualizer
    train: 
        class: TrainSettings
        data_loader: 
            class: DataLoader
            dataset: ^train_data
            batch_size: 16
            num_workers: 16
            collect_fn:
                class: ICDARCollectFN
        checkpoint: 
            class: Checkpoint
            start_epoch: 0
            start_iter: 0
            resume: null  # Stage 1에서 학습한 pretrained model 경로를 여기에 설정
        model_saver: 
            class: ModelSaver
            dir_path: model
            save_interval: 5000
            signal_path: save
        scheduler: 
            class: OptimizerScheduler
            optimizer: "SGD"
            optimizer_args:
                lr: 0.0003  # Subtitle branch만 학습하므로 더 낮은 learning rate 사용
                momentum: 0.9
                weight_decay: 0.0001
            learning_rate:  
                class: DecayLearningRate
                epochs: 200  # Subtitle branch 학습은 더 적은 epoch
                warmup_steps: 1500
        epochs: 200

    validation: &validate
        class: ValidationSettings
        data_loaders:
            icdar2015: 
                class: DataLoader
                dataset: ^validate_data
                batch_size: 1
                num_workers: 16
                collect_fn:
                    class: ICDARCollectFN
        visualize: false
        interval: 1000
        exempt: 1

    logger:
        class: Logger
        verbose: true
        level: info
        log_interval: 100

    evaluation: *validate

