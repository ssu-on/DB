import:
    - 'experiments/seg_detector/base_subtitle.yaml'
package: []
define:
  - name: 'Experiment'
    class: Experiment
    structure: 
        class: Structure
        builder: 
            class: Builder
            model: SegDetectorModel
            model_args:
                backbone: deformable_resnet18
                decoder: SegDetector
                decoder_args: 
                    adaptive: True
                    in_channels: [64, 128, 256, 512]
                    k: 50
                    # Stage 2 subtitle specialization branch on top of F5
                    subtitle_branch: True
                    subtitle_channels: 256
                    subtitle_embed_dim: 32
                # Stage 2: subtitle-only loss (no DBNet loss)
                loss_class: SubtitleBranchLoss
                # Optionally, tune loss weights for BCE vs style variance
                loss_kwargs:
                    bce_scale: 1.0
                    style_scale: 0.1
                # Let the model know this is Stage 2 so that optimizer
                # only updates subtitle branch parameters.
                stage2_subtitle_only: True

        representer:
            class: SegDetectorRepresenter
            max_candidates: 1000
        measurer:  
            class: QuadMeasurer
        visualizer:  
            class: SegDetectorVisualizer

    train: 
        class: TrainSettings
        data_loader: 
            class: DataLoader
            dataset: ^train_data
            batch_size: 8
            num_workers: 4
        checkpoint: 
            class: Checkpoint
            start_epoch: 0
            start_iter: 0
            # Stage 1 text detection checkpoint (DBNet) used as frozen backbone
            resume: './outputs/model/td500_resnet18'
        model_saver: 
            class: ModelSaver
            dir_path: model
            save_interval: 500
            signal_path: save
        scheduler: 
            class: OptimizerScheduler
            optimizer: "SGD"
            optimizer_args:
                lr: 0.001
                momentum: 0.9
                weight_decay: 0.0001
            learning_rate:  
                class: DecayLearningRate
                # train 300장 기준, batch_size 8이면 epoch당 약 40 step → 총 200 epoch ≒ 8000 step
                epochs: 200
        epochs: 200

    validation: &validate
        class: ValidationSettings
        data_loaders:
            subtitles: 
                class: DataLoader
                dataset: ^validate_data
                batch_size: 1
                num_workers: 2
                collect_fn:
                    class: ICDARCollectFN
        visualize: false
        interval: 200
        exempt: 1

    logger:
        class: Logger
        verbose: true
        level: info
        log_interval: 50

    evaluation: *validate



